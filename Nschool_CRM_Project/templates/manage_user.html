{% extends 'base.html' %}

{% load static %}
{% load bootstrap_icons %}


{% block title %}User Module{% endblock %}

{% block css %}
<link rel="stylesheet" href="{% static '/css/new_user.css' %}">
<link rel="stylesheet" href="{% static '/css/header.css' %}">
<link rel="stylesheet" href="{% static '/css/manage_user.css' %}">
{% endblock %}

{% block header %}
{% include 'header.html' %}
{% endblock %}

{% block content %}
<!-- <div class="container-fluid"> -->
<div class="row m-0 p-0">
    {% include 'side_navbar.html' %}

    <div class="col-10 background-div">

        <div class="row m-0 p-0">
            <div class="col border bg-white rounded mt-4 ms-4 mb-2 px-4">
                <nav style="--bs-breadcrumb-divider: '|';" aria-label="breadcrumb">
                    <ol class="breadcrumb pt-2">
                        <li class="breadcrumb-item"><a class="user-a" href="#">User Module</a></li>
                        <li class="breadcrumb-item active" aria-current="page">Manage User</li>
                    </ol>
                </nav>
            </div>
        </div>


        <div class="row m-0 p-0">
            <div class="col border bg-white rounded mt-2 ms-4 mb-2 px-4">

                <div class="row m-0 p-0">

                    <div class="col-5 mt-4 p-0">
                        <h5 class="fw-bold">Manage User</h5>
                    </div>

                    <div class="col-5 d-flex pe-0">
                        <form class="search-form">
                            <input type="text" class="search-input" placeholder="Search">
                            <button type="submit" class="search-button">
                                {% bs_icon 'search' %}
                            </button>
                        </form>
                    </div>

                    <div class="col-2 d-flex mt-2 mb-1 p-2 text-center gap-1">
                        <div class="col border-div">
                            <a href="javascript:void(0);" id="export-csv-link">
                                {% bs_icon 'filetype-csv' %}
                            </a>
                            <span class="csv">CSV</span>
                        </div>
                        <div class="col border-div">
                            <a href="javascript:void(0);" id="export-excel-link">
                            <?xml version="1.0" ?><svg class="excel" viewBox="0 0 24 24"
                                xmlns="http://www.w3.org/2000/svg">
                                <title />
                                <g id="Excel">
                                    <g data-name="&lt;Group&gt;" id="_Group_">
                                        <polygon data-name="&lt;Path&gt;" id="_Path_"
                                            points="13.5 0.5 0.5 3 0.5 21 13.5 23.5 13.5 0.5"
                                            style="fill:none;stroke:#303c42;stroke-linecap:round;stroke-linejoin:round" />
                                        <polyline data-name="&lt;Path&gt;" id="_Path_2"
                                            points="13.5 3.5 23.5 3.5 23.5 20.5 13.5 20.5"
                                            style="fill:none;stroke:#303c42;stroke-linecap:round;stroke-linejoin:round" />
                                        <rect data-name="&lt;Rectangle&gt;" height="1" id="_Rectangle_"
                                            style="fill:none;stroke:#303c42;stroke-linecap:round;stroke-linejoin:round"
                                            width="3" x="13.5" y="5.5" />
                                        <rect data-name="&lt;Rectangle&gt;" height="1" id="_Rectangle_2"
                                            style="fill:none;stroke:#303c42;stroke-linecap:round;stroke-linejoin:round"
                                            width="3" x="18.5" y="5.5" />
                                        <rect data-name="&lt;Rectangle&gt;" height="1" id="_Rectangle_3"
                                            style="fill:none;stroke:#303c42;stroke-linecap:round;stroke-linejoin:round"
                                            width="3" x="13.5" y="8.5" />
                                        <rect data-name="&lt;Rectangle&gt;" height="1" id="_Rectangle_4"
                                            style="fill:none;stroke:#303c42;stroke-linecap:round;stroke-linejoin:round"
                                            width="3" x="18.5" y="8.5" />
                                        <rect data-name="&lt;Rectangle&gt;" height="1" id="_Rectangle_5"
                                            style="fill:none;stroke:#303c42;stroke-linecap:round;stroke-linejoin:round"
                                            width="3" x="13.5" y="11.5" />
                                        <rect data-name="&lt;Rectangle&gt;" height="1" id="_Rectangle_6"
                                            style="fill:none;stroke:#303c42;stroke-linecap:round;stroke-linejoin:round"
                                            width="3" x="18.5" y="11.5" />
                                        <rect data-name="&lt;Rectangle&gt;" height="1" id="_Rectangle_7"
                                            style="fill:none;stroke:#303c42;stroke-linecap:round;stroke-linejoin:round"
                                            width="3" x="13.5" y="14.5" />
                                        <rect data-name="&lt;Rectangle&gt;" height="1" id="_Rectangle_8"
                                            style="fill:none;stroke:#303c42;stroke-linecap:round;stroke-linejoin:round"
                                            width="3" x="18.5" y="14.5" />
                                        <rect data-name="&lt;Rectangle&gt;" height="1" id="_Rectangle_9"
                                            style="fill:none;stroke:#303c42;stroke-linecap:round;stroke-linejoin:round"
                                            width="3" x="13.5" y="17.5" />
                                        <rect data-name="&lt;Rectangle&gt;" height="1" id="_Rectangle_10"
                                            style="fill:none;stroke:#303c42;stroke-linecap:round;stroke-linejoin:round"
                                            width="3" x="18.5" y="17.5" />
                                        <line data-name="&lt;Path&gt;" id="_Path_3"
                                            style="fill:none;stroke:#303c42;stroke-linecap:round;stroke-linejoin:round"
                                            x1="4.5" x2="8.5" y1="8.5" y2="16.5" />
                                        <line data-name="&lt;Path&gt;" id="_Path_4"
                                            style="fill:none;stroke:#303c42;stroke-linecap:round;stroke-linejoin:round"
                                            x1="4.5" x2="8.5" y1="16.5" y2="8.5" />
                                    </g>
                                </g>
                            </svg>
                            </a>
                            <span class="excel-text">EXCEL</span>
                        </div>
                        <div class="col border-div">
                            <a href="" id="export-pdf-link">
                                {% bs_icon 'file-earmark-pdf' %}
                            </a>
                            <span class="pdf">PDF</span>
                        </div>
                    </div>

                    <p class="user-para p-0">Use the below form to update your profile</p>
                </div>

                <!-- Pagination controls -->
                <div class="row">
                    <div class="col d-flex justify-content-end py-3 gap-2">
                        <form id="perPageForm" method="get" class="d-flex">
                            <select class="select-div me-2" name="per_page" id="perPageSelect"
                                onchange="document.getElementById('perPageForm').submit();">
                                <option value="10" {% if per_page == '10' %}selected{% endif %}>10 per page</option>
                                <option value="20" {% if per_page == '20' %}selected{% endif %}>20 per page</option>
                                <option value="30" {% if per_page == '30' %}selected{% endif %}>30 per page</option>
                            </select>
                            <span id="item-range" class="item-range align-content-center">.
                                {{ page_obj.start_index}}-{{ page_obj.end_index }}
                            </span>

                            {% if page_obj.has_previous %}
                            <a class="anchor align-content-center"
                                href="?page={{ page_obj.previous_page_number }}&per_page={{ per_page }}"><span
                                    class="page-icon">{% bs_icon 'chevron-left' %}</span></a>
                            {% endif %}
                            {% if page_obj.has_next %}
                            <a class="anchor align-content-center"
                                href="?page={{ page_obj.next_page_number }}&per_page={{ per_page }}">
                                <span class="page-icon">{% bs_icon 'chevron-right' %}</span>
                            </a>
                            {% endif %}

                        </form>
                        <span data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-custom-class="custom-tooltip"
                            data-bs-title="delete">
                            <a href="javascript:void(0);" id="deleteSelected">
                                <span class="delete">
                                    <?xml version="1.0" ?>
                                    <!DOCTYPE svg
                                        PUBLIC '-//W3C//DTD SVG 1.1//EN' 'http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd'>
                                    <svg class="delete-icon" height="512px" id="Layer_1"
                                        style="enable-background:new 0 0 512 512;" version="1.1" viewBox="0 0 512 512"
                                        width="512px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg"
                                        xmlns:xlink="http://www.w3.org/1999/xlink">
                                        <g>
                                            <path
                                                d="M400,113.3h-80v-20c0-16.2-13.1-29.3-29.3-29.3h-69.5C205.1,64,192,77.1,192,93.3v20h-80V128h21.1l23.6,290.7   c0,16.2,13.1,29.3,29.3,29.3h141c16.2,0,29.3-13.1,29.3-29.3L379.6,128H400V113.3z M206.6,93.3c0-8.1,6.6-14.7,14.6-14.7h69.5   c8.1,0,14.6,6.6,14.6,14.7v20h-98.7V93.3z M341.6,417.9l0,0.4v0.4c0,8.1-6.6,14.7-14.6,14.7H186c-8.1,0-14.6-6.6-14.6-14.7v-0.4   l0-0.4L147.7,128h217.2L341.6,417.9z" />
                                            <g>
                                                <rect height="241" width="14" x="249" y="160" />
                                                <polygon points="320,160 305.4,160 294.7,401 309.3,401   " />
                                                <polygon points="206.5,160 192,160 202.7,401 217.3,401   " />
                                            </g>
                                        </g>
                                    </svg>
                                </span>
                            </a>

                        </span>
                    </div>
                </div>

                <div class="row">
                    <div class="col my-2">
                        <table class="tabel-div">
                            <tr>
                                <th class="check">
                                    <input type="checkbox" class="form-check-input" name="checkbox" id="select_all">
                                </th>
                                <th class="thead">Name</th>
                                <th class="thead">E-Mail-ID</th>
                                <th class="thead">Contact</th>
                                <th class="Permission">Permission</th>
                                <th class="password">Password</th>
                                <th class="action">Action</th>
                            </tr>
                            {% for user in page_obj %}
                            <tr class="trow">
                                <td class="check1">
                                    <input type="checkbox" class="form-check-input user-checkbox" name="user_ids"
                                        value="{{ user.id }}" id="user{{ user.id }}">
                                </td>
                                <td class="tdata">{{ user.name }}</td>
                                <td class="tdata">{{ user.email }}</td>
                                <td class="tdata">{{ user.contact|stringformat:"s" }}</td>
                                <td class="permission">
                                    <div class="perm">
                                        {% if user.enquiry %}<span class="enquiry">Enquiry</span>{% endif %}
                                        {% if user.enrollment %}<span class="enrollment">Enrollment</span>{% endif %}
                                        {% if user.attendance %}<span class="attendance">Attendance</span>{% endif %}
                                        {% if user.staff %}<span class="staff">Staff</span>{% endif %}
                                        {% if user.placement %}<span class="placement">Placement</span>{% endif %}
                                        {% if user.report %}<span class="report">Report</span>{% endif %}
                                    </div>
                                </td>
                                <td class="tdata">
                                    <div>
                                        <span>
                                            {% if user.password %}
                                            <!-- {% for i in user.password %}
                                                    *
                                                {% endfor %} -->
                                            {{user.password}}
                                            {% endif %}
                                        </span>
                                    </div>
                                </td>
                                <td class="tdata">
                                    <div>
                                        <a href="/update_user/{{user.id}}">
                                            <span class="edit">
                                                {% bs_icon 'pencil' %}
                                            </span>
                                        </a>
                                        <a href="/delete_user/{{user.id}}">
                                            <span class="delete">
                                                {% bs_icon 'trash3' %}
                                            </span>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </table>
                        <!-- <button type="button" class="btn btn-danger" id="deleteSelected">Delete Selected Users</button> -->
                    </div>
                </div>

            </div>
        </div>

    </div>
</div>
<!-- CSRF token -->
<input type="hidden" id="csrfToken" value="{{ csrf_token }}">


{% endblock %}


{% block scripts %}
<script>
    function toggleDropdown(element) {
        // Close all dropdowns
        const allDropdowns = document.querySelectorAll('.dropdown-menu');
        allDropdowns.forEach(dropdown => {
            if (dropdown !== element.nextElementSibling) {
                dropdown.classList.remove('show');
            }
        });

        // Close all arrows
        const allArrows = document.querySelectorAll('.right_arrow');
        allArrows.forEach(arrow => {
            if (arrow !== element.querySelector('.right_arrow')) {
                arrow.classList.remove('arrow_user');
            }
        });

        // Toggle the clicked dropdown and arrow
        const dropdownMenu = element.nextElementSibling;
        dropdownMenu.classList.toggle('show');
        const rightArrow = element.querySelector('.right_arrow');
        rightArrow.classList.toggle('arrow_user');
    }

    document.getElementById('toggle-sidenav').addEventListener('click', function () {
        const sidenav = document.getElementById('sidenav');
        sidenav.classList.toggle('collapsed');
    });


    document.getElementById('select_all').addEventListener('change', function () {
        let checkboxes = document.querySelectorAll('.user-checkbox');
        checkboxes.forEach(checkbox => {
            checkbox.checked = this.checked;
        });
    });

    document.addEventListener('DOMContentLoaded', function () {
        const selectAllCheckbox = document.getElementById('select_all');
        const userCheckboxes = document.querySelectorAll('.user-checkbox');
        const deleteSelectedButton = document.getElementById('deleteSelected');
        const csrfToken = document.getElementById('csrfToken').value;

        // Select all checkboxes functionality
        selectAllCheckbox.addEventListener('change', function () {
            userCheckboxes.forEach(function (checkbox) {
                checkbox.checked = selectAllCheckbox.checked;
            });
        });

        // Delete selected users via AJAX
        deleteSelectedButton.addEventListener('click', function () {
            const selectedUserIds = Array.from(userCheckboxes)
                .filter(checkbox => checkbox.checked)
                .map(checkbox => checkbox.value);

            if (selectedUserIds.length > 0) {
                if (confirm('Are you sure you want to delete the selected users?')) {
                    fetch('/delete_all_user/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken
                        },
                        body: JSON.stringify({ user_ids: selectedUserIds })
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                window.location.reload();
                            } else {
                                alert('An error occurred: ' + data.error);
                            }
                        })
                        .catch(error => console.error('Error:', error));
                }
            } else {
                alert('No users selected for deletion.');
            }
        });
    });


    //     document.addEventListener('DOMContentLoaded', () => {
    //     const selectAllCheckbox = document.getElementById('select_all');
    //     const userCheckboxes = document.querySelectorAll('.user-checkbox');
    //     const fileformatButton = document.getElementById('fileformat');
    //     const csrfToken = document.getElementById('csrfToken').value;

    //     // Toggle all checkboxes
    //     selectAllCheckbox.addEventListener('change', () => {
    //         userCheckboxes.forEach(checkbox => checkbox.checked = selectAllCheckbox.checked);
    //     });

    //     // Export selected users as CSV
    //     fileformatButton.addEventListener('click', () => {
    //         const selectedUserIds = Array.from(userCheckboxes)
    //             .filter(checkbox => checkbox.checked)
    //             .map(checkbox => checkbox.value);

    //         if (selectedUserIds.length === 0) {
    //             alert('No users selected.');
    //             return;
    //         }

    //         fetch('/export_courses_csv/', {
    //             method: 'POST',
    //             headers: {
    //                 'Content-Type': 'application/json',
    //                 'X-CSRFToken': csrfToken
    //             },
    //             body: JSON.stringify({ user_ids: selectedUserIds })
    //         })
    //         .then(response => {
    //             if (!response.ok) {
    //                 throw new Error('Network response was not ok');
    //             }
    //             return response.blob();
    //         })
    //         .then(blob => {
    //             console.log(blob)
    //             const url = URL.createObjectURL(blob);
    //             console.log(url)
    //             const a = document.createElement('a');
    //             a.href = url;
    //             a.download = 'course_list_csv.csv';
    //             document.body.appendChild(a);
    //             a.click();
    //             URL.revokeObjectURL(url);
    //         })
    //         .catch(error => {
    //             console.error('Error:', error);
    //             alert('An error occurred.');
    //         });
    //     });
    // });


    document.addEventListener('DOMContentLoaded', function () {
        // Function to send selected course IDs for CSV export
        async function exportCoursesCSV(ids) {
            try {
                const csrftoken = getCookie('csrftoken');
                let formData = new FormData();
                formData.append('ids', ids.join(','));  // Convert ids array to comma-separated string
                formData.append('csrfmiddlewaretoken', csrftoken);

                let response = await fetch('/export_user_csv/', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }

                // Download the CSV file
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = 'user_list_csv.csv';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
            } catch (error) {
                console.error('Error:', error);
                // Handle error appropriately (e.g., show error message to user)
            }
        }

        // Function to send selected course IDs for Excel export
        async function exportCoursesExcel(ids) {
            try {
                const csrftoken = getCookie('csrftoken');
                let formData = new FormData();
                formData.append('ids', ids.join(','));  // Convert ids array to comma-separated string

                formData.append('csrfmiddlewaretoken', csrftoken);

                let response = await fetch('/export_user_excel/', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }

                // Download the Excel file
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                console.log(url)
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = 'user_list_excel.xlsx';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
            } catch (error) {
                console.error('Error:', error);
                // Handle error appropriately (e.g., show error message to user)
            }
        }

        // Function to send selected course IDs for PDF export
        async function exportCoursesPDF(ids) {
            try {
                const csrftoken = getCookie('csrftoken');
                if (!csrftoken) {
                    throw new Error('CSRF token not found');
                }

                let formData = new FormData();
                formData.append('ids', ids.join(','));  // Convert ids array to comma-separated string
                formData.append('csrfmiddlewaretoken', csrftoken);

                // Debug: log the form data contents
                for (let [key, value] of formData.entries()) {
                    console.log(`${key}: ${value}`);
                }

                let response = await fetch('/export_user_pdf/', {
                    method: 'POST',
                    body: formData,
                });

                if (!response.ok) {
                    console.log("response not ok!");
                    let text = await response.text();
                    console.error(text);
                    throw new Error('Network response was not ok');
                }

                // Download the PDF file
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = 'user_list.pdf';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred while exporting the user list PDF. Please try again.');
            }
        }


        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.startsWith(name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Example: Trigger CSV export on button click
        document.getElementById('export-csv-link').addEventListener('click', function () {
            // Replace with your logic to get selected course IDs
            // const selectedIds = [1, 2]; // Example: Replace with actual selected IDs
            let checkboxes = document.querySelectorAll('input[type="checkbox"]:checked');
            let selectedIds = Array.from(checkboxes).map(checkbox => checkbox.value).filter(id => id !== 'on');
            console.log(selectedIds);  // Check the selected IDs in the console

            if (selectedIds.length > 0) {
                exportCoursesCSV(selectedIds);
            } else {
                alert('Please select at least one course to export.');
            }
        });

        // Example: Trigger Excel export on button click
        document.getElementById('export-excel-link').addEventListener('click', function () {
            // Replace with your logic to get selected course IDs
            // const selectedIds = [1, 2]; // Example: Replace with actual selected IDs
            let checkboxes = document.querySelectorAll('input[type="checkbox"]:checked');
            let selectedIds = Array.from(checkboxes).map(checkbox => checkbox.value).filter(id => id !== 'on');
            console.log(selectedIds);  // Check the selected IDs in the console

            if (selectedIds.length > 0) {
                exportCoursesExcel(selectedIds);
            } else {
                alert('Please select at least one course to export.');
            }
        });

        // Example: Trigger PDF export on button click
        document.getElementById('export-pdf-link').addEventListener('click', function () {
            // Replace with your logic to get selected course IDs
            // const selectedIds = [1, 2]; // Example: Replace with actual selected IDs
            let checkboxes = document.querySelectorAll('input[type="checkbox"]:checked');
            let selectedIds = Array.from(checkboxes).map(checkbox => checkbox.value).filter(id => id !== 'on');
            console.log(selectedIds);  // Check the selected IDs in the console

            if (selectedIds.length > 0) {
                exportCoursesPDF(selectedIds);
            } else {
                alert('Please select at least one course to export.');
            }
        });

    });






</script>
{% endblock %}